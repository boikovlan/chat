<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Firebase Chat Rooms - Universal</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ */
        :root {
            --bg-color: #f0f2f5; 
            --header-bg: #008069; 
            --header-text: #ffffff; 
            --my-msg-bg: #d9fdd3; 
            --other-msg-bg: #ffffff; 
            --text-color: #000000; 
            --primary: #008069; 
            --input-bg: #ffffff; 
            --log-bg: #e9e9e9; 
            --log-text: #666666; 
            --active-color: #38c172;
            --inactive-color: #e3342f;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            /* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 100% vh, –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –Ω–∞ iOS */
            height: 100vh;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        /* === –û–°–ù–û–í–ù–´–ï –≠–ö–†–ê–ù–´ === */
        #main-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #room-list-screen, #join-room-screen, #chat-container, #log-screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: var(--bg-color);
            padding: 0;
            box-sizing: border-box;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* === –≠–ö–†–ê–ù –°–ü–ò–°–ö–ê –ö–û–ú–ù–ê–¢ === */
        #room-list-screen {
             /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–º–µ–Ω–∏ */
        }
        
        .list-header {
            width: 100%;
            background: var(--header-bg);
            color: var(--header-text);
            padding: 15px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            position: fixed;
            top: 0;
            z-index: 10;
        }
        .list-header h1 { margin: 0; font-size: 18px; }

        #room-list {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            overflow-y: auto;
            padding: 20px 10px;
            padding-top: 80px; /* –û—Ç—Å—Ç—É–ø –æ—Ç fixed header */
        }

        .room-entry {
            background: var(--other-msg-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-left: 5px solid;
        }
        .room-entry.active { border-left-color: var(--active-color); }
        .room-entry.inactive { border-left-color: var(--inactive-color); }

        .room-info h3 { margin: 0 0 5px 0; font-size: 16px; color: var(--text-color); }
        .room-info p { margin: 0; font-size: 12px; color: #888; }

        .room-status {
            font-weight: bold;
            font-size: 11px;
            padding: 5px 8px;
            border-radius: 4px;
            color: white;
        }
        .room-status.active { background: var(--active-color); }
        .room-status.inactive { background: var(--inactive-color); }

        .action-button {
            background: var(--primary);
            color: var(--header-text);
            border: none;
            padding: 12px;
            width: 90%;
            max-width: 300px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 auto 20px auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* === –≠–ö–†–ê–ù –°–û–ó–î–ê–ù–ò–Ø/–í–•–û–î–ê === */
        #join-room-screen {
            justify-content: center;
            align-items: center;
        }
        .join-box {
            width: 100%; max-width: 320px; text-align: center;
            background: var(--other-msg-bg); padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .login-input {
            width: 100%; padding: 14px; margin: 10px 0;
            border: 1px solid #cccccc; background: var(--input-bg);
            color: var(--text-color); border-radius: 8px; font-size: 16px;
            box-sizing: border-box; outline: none;
        }
        .btn-back {
            background: #888; color: white; border: none;
            padding: 10px; width: 100%; border-radius: 8px;
            font-size: 14px; cursor: pointer; margin-top: 10px;
        }

        /* === –ß–ê–¢ / –°–û–û–ë–©–ï–ù–ò–Ø === */
        #chat-container { z-index: 20; }
        header {
            background: var(--header-bg); padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10;
            color: var(--header-text);
        }
        .header-info h2 { margin: 0; font-size: 17px; color: var(--header-text); }
        .header-info h3 { margin: 0; font-size: 13px; color: rgba(255, 255, 255, 0.8); font-weight: 400; }
        
        #messages-area {
            flex: 1; 
            overflow-y: auto; 
            padding: 15px 15px 80px 15px; 
            display: flex; flex-direction: column; gap: 8px;
            background-color: var(--bg-color);
            -webkit-overflow-scrolling: touch;
        }

        .message {
            max-width: 80%; padding: 8px 10px; border-radius: 8px;
            position: relative; word-wrap: break-word; font-size: 15px;
            line-height: 1.4; box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            color: var(--text-color);
        }
        .message.mine { align-self: flex-end; background: var(--my-msg-bg); border-top-right-radius: 0; }
        .message.others { align-self: flex-start; background: var(--other-msg-bg); border: 1px solid #f0f0f0; border-top-left-radius: 0; }
        .msg-sender { font-size: 11px; font-weight: bold; margin-bottom: 2px; display: block; }
        .msg-status { font-size: 8px; font-weight: bold; color: #008069; margin-left: 5px; }
        .msg-status.sent { color: #888888; }
        .msg-status.delivered { color: #008069; }

        /* === –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê (–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Å–¥–≤–∏–≥–∞) === */
        .input-area {
            position: absolute; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: var(--bg-color); 
            padding: 10px; 
            display: flex;
            align-items: center; 
            gap: 10px; 
            box-sizing: border-box; 
            z-index: 20;
            border-top: 1px solid #dddddd;
        }

        #msg-input {
            flex: 1; 
            padding: 12px 15px; border-radius: 20px;
            border: none; background: var(--input-bg); color: var(--text-color);
            font-size: 16px; outline: none; box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        .icon-btn { background: none; border: none; font-size: 22px; cursor: pointer; padding: 0 5px; color: #8696a0; display: flex; align-items: center; justify-content: center; }
        .icon-btn.send { color: var(--primary); }
        
        /* === –ê–î–ú–ò–ù-–õ–û–ì === */
        #log-screen { z-index: 30; }
        #log-header {
            background: var(--header-bg); 
            color: var(--header-text); 
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        #log-content {
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            background: #ffffff;
            font-family: monospace;
            font-size: 12px;
            color: #333;
        }
        .log-entry-item {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px dotted #eee;
            white-space: pre-wrap;
        }
        .log-entry-item .time { color: #999; margin-right: 10px; }
        .log-entry-item .user { font-weight: bold; color: var(--primary); }
        .log-entry-item .action { color: #cc0000; }
        .log-entry-item .auth { color: #00796b; }
        
        /* === STATUS LOG (–Ω–∏–∂–Ω–∏–π) === */
        #status-log {
            background: var(--log-bg);
            color: var(--log-text);
            font-family: monospace;
            font-size: 10px;
            padding: 5px 15px;
            overflow-x: auto;
            white-space: nowrap;
            border-bottom: 1px solid #cccccc;
        }

    </style>
</head>
<body>

    <div id="main-container">
        
        <div id="error-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 0, 0, 0.9); color: white; z-index: 9999; padding: 20px; text-align: center;">
            <h2>üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞! üö®</h2>
            <p id="error-message">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.</p>
            <p>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</p>
            <ul>
                <li>‚ùå **–ù–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ Firebase Firestore** (—Å–∞–º–∞—è —á–∞—Å—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞!).</li>
                <li>‚ùå –ë–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫ —Ä–µ–∫–ª–∞–º—ã/—Ç—Ä–µ–∫–µ—Ä–æ–≤.</li>
            </ul>
            <button onclick="window.location.reload(true)" style="padding: 10px 20px; background: white; color: black; border: none; border-radius: 5px; margin-top: 20px;">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>


        <div id="room-list-screen">
            <div class="list-header">
                <h1>–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –°–æ–∑–¥–∞–π—Ç–µ –ö–æ–º–Ω–∞—Ç—É</h1>
                <p>–í–∞—à–µ –∏–º—è: <span id="current-user-name"></span></p>
            </div>
            <div id="room-list">
                </div>
            <button class="action-button" onclick="showJoinRoomScreen('create')">‚ûï –°–æ–∑–¥–∞—Ç—å –ù–æ–≤—É—é –ö–æ–º–Ω–∞—Ç—É</button>
            <button class="action-button btn-back" style="background: #e3342f; margin-bottom: 50px;" onclick="promptForUsername(true)">–°–º–µ–Ω–∏—Ç—å –ò–º—è</button>
        </div>

        <div id="join-room-screen">
            <div class="join-box">
                <h1 style="color:var(--text-color); margin-top:0;" id="join-title"></h1>
                <p style="color:#8696a0; font-size: 13px;">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã</p>
                <input type="text" id="roomname" class="login-input" placeholder="–ò–º—è –ö–æ–º–Ω–∞—Ç—ã">
                <input type="password" id="roompassword" class="login-input" placeholder="–ü–∞—Ä–æ–ª—å –ö–æ–º–Ω–∞—Ç—ã (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≤—Ö–æ–¥–∞)">
                <button class="btn" id="join-action-btn" onclick="attemptRoomAction()"></button>
                <button class="btn-back" onclick="showScreen('room-list-screen')">–û—Ç–º–µ–Ω–∞</button>
                <p id="join-error" style="color:#ef5350; font-size: 13px; margin-bottom: 0;"></p>
            </div>
        </div>
        
        <div id="log-screen">
            <header id="log-header">
                <h2>–ñ—É—Ä–Ω–∞–ª –î–µ–π—Å—Ç–≤–∏–π <span id="log-chat-name"></span></h2>
                <button onclick="toggleLogScreen()">–ù–∞–∑–∞–¥ –≤ —á–∞—Ç</button>
            </header>
            <div id="log-content">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
        </div>

        <div id="chat-container">
            <header>
                <div class="header-info">
                    <h2 id="current-chat-name"></h2>
                    <h3><span id="typing-indicator"></span></h3>
                </div>
                <div class="header-btns">
                    <button onclick="toggleLogScreen()">–õ–æ–≥–∏</button>
                    <button onclick="leaveRoom()">–í—ã–π—Ç–∏</button>
                </div>
            </header>

            <div id="online-users"></div>
            <div id="status-log"></div> 

            <div id="messages-area"></div>

            <div class="input-area">
                <input type="file" id="file-input" accept="image/*" onchange="handleImageUpload(this)">
                <button class="icon-btn" onclick="document.getElementById('file-input').click()">üì∑</button>
                <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" oninput="handleTyping(event)">
                <button class="icon-btn send" id="send-btn">‚û§</button>
            </div>
        </div>
        
    </div> <script>
        // =======================================================
        // üî•üî•üî• –í–ê–®–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE üî•üî•üî•
        // =======================================================
        const FIREBASE_CONFIG = {
          apiKey: "AIzaSyCRX_a2a-O7Dp6Kh5Vy2RSZ6Q3mxoKB8CI",
          authDomain: "chat-2a529.firebaseapp.com",
          projectId: "chat-2a529",
          storageBucket: "chat-2a529.firebasestorage.app",
          messagingSenderId: "684082757254",
          appId: "1:684082757254:web:053e781efb9837c1981b07",
          measurementId: "G-ZHQ4ZF3SKF"
        };
        // =======================================================

        let currentUser = { name: "", chat: "", ip: "", device: "", roomAction: "" };
        let typingTimeout;
        let db; 
        let lastStatusUpdateTime = Date.now();
        const MAX_LOG_ENTRIES = 5; 
        
        // --- –°–¢–ê–†–¢–û–í–û–ï –°–û–°–¢–û–Ø–ù–ò–ï –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        
        try {
            firebase.initializeApp(FIREBASE_CONFIG);
            db = firebase.firestore();
            console.log('SDK: Initialized'); 
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
            document.getElementById('error-message').innerText = "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏ –≤ –∫–æ–¥–µ.";
            document.getElementById('error-overlay').style.display = 'flex';
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('msg-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        // --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –≠–ö–†–ê–ù–ê–ú–ò ---

        function showScreen(screenId) {
            document.getElementById('room-list-screen').style.display = 'none';
            document.getElementById('join-room-screen').style.display = 'none';
            document.getElementById('chat-container').style.display = 'none';
            document.getElementById('log-screen').style.display = 'none';
            document.getElementById(screenId).style.display = 'flex';
        }
        
        function showJoinRoomScreen(actionType, roomName = '') {
            currentUser.roomAction = actionType;
            const title = document.getElementById('join-title');
            const actionBtn = document.getElementById('join-action-btn');
            const roomInput = document.getElementById('roomname');
            const passInput = document.getElementById('roompassword');
            document.getElementById('join-error').innerText = '';
            
            if (actionType === 'create') {
                title.innerText = '–°–æ–∑–¥–∞—Ç—å –ù–æ–≤—É—é –ö–æ–º–Ω–∞—Ç—É';
                actionBtn.innerText = '–°–û–ó–î–ê–¢–¨ –ò –í–û–ô–¢–ò';
                roomInput.value = '';
                passInput.placeholder = '–ü–∞—Ä–æ–ª—å –ö–æ–º–Ω–∞—Ç—ã (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)';
            } else { // join
                title.innerText = `–í–æ–π—Ç–∏ –≤ –ö–æ–º–Ω–∞—Ç—É: ${roomName}`;
                actionBtn.innerText = '–í–û–ô–¢–ò';
                roomInput.value = roomName;
                passInput.value = '';
                passInput.placeholder = '–ü–∞—Ä–æ–ª—å –ö–æ–º–Ω–∞—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)';
            }
            
            showScreen('join-room-screen');
        }

        function toggleLogScreen() {
            const chatScreen = document.getElementById('chat-container');
            const logScreen = document.getElementById('log-screen');

            if (chatScreen.style.display === 'flex') {
                chatScreen.style.display = 'none';
                logScreen.style.display = 'flex';
                loadAuditLog(); 
            } else {
                logScreen.style.display = 'none';
                chatScreen.style.display = 'flex';
            }
        }
        
        // --- –õ–û–ì–ò–ù –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ú–ù–ê–¢–ê–ú–ò ---
        
        /**
         * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. 
         * @param {boolean} forcePrompt - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∏–º—è, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.
         * @returns {boolean} –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, –µ—Å–ª–∏ –∏–º—è —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–æ/—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.
         */
        function promptForUsername(forcePrompt = false) {
            const storedName = localStorage.getItem('currentUser_name');
            
            if (!forcePrompt && storedName) {
                currentUser.name = storedName;
                document.getElementById('current-user-name').innerText = currentUser.name;
                return true;
            }

            let name = prompt("–í–≤–µ–¥–∏—Ç–µ –í–∞—à–µ –ò–º—è (1-15 —Å–∏–º–≤–æ–ª–æ–≤):", storedName || "");
            
            if (name && name.trim()) {
                currentUser.name = name.trim().substring(0, 15);
                localStorage.setItem('currentUser_name', currentUser.name);
                document.getElementById('current-user-name').innerText = currentUser.name;
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é, –µ—Å–ª–∏ –∏–º—è –º–µ–Ω—è–µ—Ç—Å—è
                if (currentUser.chat) leaveRoom(false);
                return true;
            } else {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –û—Ç–º–µ–Ω–∞ –∏–ª–∏ –≤–≤–µ–ª –ø—É—Å—Ç–æ–µ –∏–º—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É, 
                // —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å –ª–æ–≥–∏–∫—É.
                if (!storedName) {
                    currentUser.name = "Guest_" + Math.random().toString(36).substring(2, 7);
                    localStorage.setItem('currentUser_name', currentUser.name);
                }
                document.getElementById('current-user-name').innerText = currentUser.name;
                return false; 
            }
        }
        
        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞—Ç–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ø–∏—Å–∫—É –∫–æ–º–Ω–∞—Ç.
         */
        async function checkAndLoadUser() {
            if (!db) return;
            
            // –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            promptForUsername(false); 
            
            // –®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (IP, Device)
            await getMetadata();
            
            // –®–∞–≥ 3: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
            showScreen('room-list-screen');
            loadRooms();
        }

        async function attemptRoomAction() {
            const roomName = document.getElementById('roomname').value.trim();
            const roomPass = document.getElementById('roompassword').value;
            const err = document.getElementById('join-error');
            
            if (!roomName) { err.innerText = "–£–∫–∞–∂–∏—Ç–µ –∏–º—è –∫–æ–º–Ω–∞—Ç—ã!"; return; }

            const roomRef = db.collection('rooms').doc(roomName);

            try {
                const doc = await roomRef.get();
                
                if (currentUser.roomAction === 'create') {
                    if (!roomPass) { err.innerText = "–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å!"; return; }
                    if (doc.exists) { err.innerText = `–ö–æ–º–Ω–∞—Ç–∞ "${roomName}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –∏–º—è.`; return; }
                    
                    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã
                    await roomRef.set({
                        name: roomName,
                        password: roomPass,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.name
                    });
                    currentUser.chat = roomName;
                    startChatSession();
                    
                } else { // join
                    if (!doc.exists) { err.innerText = `–ö–æ–º–Ω–∞—Ç–∞ "${roomName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`; return; }
                    const roomData = doc.data();
                    
                    if (roomData.password && roomData.password !== roomPass) {
                        err.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∫–æ–º–Ω–∞—Ç—ã!";
                        return;
                    }

                    currentUser.chat = roomName;
                    startChatSession();
                }

            } catch(e) {
                console.error("Room action failed:", e);
                err.innerText = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ –∫–æ–º–Ω–∞—Ç–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firebase.";
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏
                if (e.code === 'permission-denied') {
                    document.getElementById('error-message').innerText = "–û—à–∏–±–∫–∞: –î–æ—Å—Ç—É–ø –∫ Firestore –∑–∞–ø—Ä–µ—â–µ–Ω. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ Firebase.";
                    document.getElementById('error-overlay').style.display = 'flex';
                }
            }
        }
        
        // --- –ó–ê–ì–†–£–ó–ö–ê –ò –†–ï–ù–î–ï–†–ò–ù–ì –ö–û–ú–ù–ê–¢ ---

        function loadRooms() {
             // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å try/catch –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∞–≤–∏–ª
             db.collection('rooms').onSnapshot(async snapshot => {
                const roomListElement = document.getElementById('room-list');
                roomListElement.innerHTML = '';
                
                const rooms = [];
                snapshot.forEach(doc => rooms.push({ id: doc.id, ...doc.data() }));

                // –ï—Å–ª–∏ –∫–æ–º–Ω–∞—Ç –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Å –∫–Ω–æ–ø–∫–æ–π "–°–æ–∑–¥–∞—Ç—å"
                if (rooms.length === 0) {
                     roomListElement.innerHTML = '<p style="text-align: center; color: #888;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</p>';
                     return;
                }

                // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                const activeStatusPromises = rooms.map(room => 
                    db.collection('users').where('chat', '==', room.name).get()
                );
                
                const results = await Promise.all(activeStatusPromises);
                
                results.forEach((querySnapshot, index) => {
                    const room = rooms[index];
                    let activeUsersCount = 0;
                    const now = Date.now();
                    
                    querySnapshot.forEach(userDoc => {
                        const userData = userDoc.data();
                        const lastSeenTime = userData.lastSeen ? userData.lastSeen.toDate().getTime() : now;
                        // –°—á–∏—Ç–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º, –µ—Å–ª–∏ –æ–Ω–ª–∞–π–Ω –∏ –±—ã–ª –≤–∏–¥–µ–Ω –º–µ–Ω–µ–µ 30 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
                        if (userData.isOnline && now - lastSeenTime < 30000) {
                            activeUsersCount++;
                        }
                    });

                    renderRoomEntry(room, activeUsersCount);
                });
            }, error => {
                // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –ø—Ä–∞–≤–∏–ª Firebase)
                console.error("Error loading rooms:", error);
                if (error.code === 'permission-denied') {
                    document.getElementById('error-message').innerText = "–û—à–∏–±–∫–∞: –î–æ—Å—Ç—É–ø –∫ Firestore –∑–∞–ø—Ä–µ—â–µ–Ω. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ Firebase (allow read, write: if true;).";
                    document.getElementById('error-overlay').style.display = 'flex';
                }
            });
        }
        
        function renderRoomEntry(room, activeUsersCount) {
            const roomListElement = document.getElementById('room-list');
            const isActive = activeUsersCount > 0;
            const div = document.createElement('div');
            div.className = `room-entry ${isActive ? 'active' : 'inactive'}`;
            div.setAttribute('data-room-name', room.name);
            div.onclick = () => showJoinRoomScreen('join', room.name);

            const statusText = isActive ? '–ê–ö–¢–ò–í–ù–ê' : '–ù–ï–ê–ö–¢–ò–í–ù–ê';
            const statusUsers = isActive ? `(${activeUsersCount} –æ–Ω–ª–∞–π–Ω)` : '';
            
            div.innerHTML = `
                <div class="room-info">
                    <h3># ${room.name}</h3>
                    <p>–°–æ–∑–¥–∞–Ω–∞: ${room.createdBy}</p>
                </div>
                <div class="room-status ${isActive ? 'active' : 'inactive'}">
                    ${statusText} ${statusUsers}
                </div>
            `;
            roomListElement.appendChild(div);
        }

        // --- –õ–û–ì–ò–ö–ê –ß–ê–¢–ê ---

        function startChatSession() {
            document.getElementById('current-chat-name').innerText = `# ${currentUser.chat}`;
            showScreen('chat-container');

            setUserStatus({ isOnline: true, isTyping: false });
            setupFirestoreListeners();
            setInterval(checkInactivity, 10000); 

            document.addEventListener('touchstart', updateActivity);
            document.addEventListener('keydown', updateActivity);
            document.addEventListener('mousemove', updateActivity);
            
            window.addEventListener('beforeunload', () => setUserStatus({ isOnline: false }));
            
            recordAudit('login', { room: currentUser.chat });
        }
        
        function leaveRoom(reload = true) {
            setUserStatus({ isOnline: false });
            recordAudit('logout', { room: currentUser.chat });
            currentUser.chat = "";
            if (reload) window.location.reload(true);
        }
        
        async function getMetadata() {
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipRes.json();
                currentUser.ip = ipData.ip;
            } catch (e) { currentUser.ip = "Unknown"; }

            const ua = navigator.userAgent;
            if (ua.match(/iPhone|iPad|iPod/i)) currentUser.device = "iPhone/iOS";
            else if (ua.match(/Android/i)) currentUser.device = "Android";
            else if (ua.match(/Windows/i)) currentUser.device = "PC";
            else currentUser.device = "Web";
        }
        
        // --- FIREBASE –ò –õ–û–ì–ò–ö–ê –°–¢–ê–¢–£–°–û–í (–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥ –∫–æ–º–Ω–∞—Ç—ã) ---

        function setupFirestoreListeners() {
            if (!currentUser.chat) return;
            
            // 1. –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π: chats/{chatName}/messages
            db.collection(`chats/${currentUser.chat}/messages`).orderBy('timestamp', 'asc').onSnapshot(snapshot => {
                logStatus('READ'); 
                const messages = [];
                const readPromises = [];

                snapshot.docChanges().forEach(change => {
                    const msg = { ...change.doc.data(), id: change.doc.id };
                    messages.push(msg);

                    if (change.type === "added" && msg.status !== 'delivered' && msg.user !== currentUser.name) {
                        readPromises.push(markMessageAsDelivered(msg.id)); 
                    }
                });

                Promise.all(readPromises).then(() => {
                    renderMessages(messages);
                    scrollToBottom();
                });
            }, error => {
                console.error("Error reading messages:", error);
                 if (error.code === 'permission-denied') {
                    document.getElementById('error-message').innerText = "–û—à–∏–±–∫–∞: –î–æ—Å—Ç—É–ø –∫ —Å–æ–æ–±—â–µ–Ω–∏—è–º –∑–∞–ø—Ä–µ—â–µ–Ω. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ Firebase.";
                    document.getElementById('error-overlay').style.display = 'flex';
                }
            });

            // 2. –°–ª—É—à–∞—Ç–µ–ª—å —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: users (—Ñ–∏–ª—å—Ç—Ä –ø–æ –∏–º–µ–Ω–∏ —á–∞—Ç–∞)
            db.collection('users').where('chat', '==', currentUser.chat).onSnapshot(snapshot => {
                const users = [];
                snapshot.forEach(doc => users.push(doc.data()));
                renderOnlineUsers(users);
                renderTypingIndicator(users);
            });
        }
        
        async function markMessageAsDelivered(msgId) {
             const msgRef = db.collection(`chats/${currentUser.chat}/messages`).doc(msgId);
             
             try {
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(msgRef);
                    if (!doc.exists || doc.data().status !== 'sent') {
                        return;
                    }
                    transaction.update(msgRef, { status: 'delivered' });
                });
                recordAudit('read_msg', { id: msgId, room: currentUser.chat }); 
                return true;

             } catch (e) {
                 console.error("Transaction failed: ", e);
                 return false;
             }
        }


        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();

            if (!text) return;

            try {
                const docRef = await db.collection(`chats/${currentUser.chat}/messages`).add({
                    user: currentUser.name,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    edited: false,
                    status: 'sent'
                });
                
                logStatus('WRITE', '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); 
                recordAudit('send', { id: docRef.id, message: text, room: currentUser.chat }); 
                
                input.value = '';
                input.focus(); 
                setUserStatus({ isTyping: false });

            } catch(e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:", e);
                alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø—Ä–∞–≤–∏–ª–∞ Firebase.");
            }
        }
        
        async function deleteMessage(id) {
            if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) return;
            await db.collection(`chats/${currentUser.chat}/messages`).doc(id).delete();
            recordAudit('delete', { id: id, room: currentUser.chat }); 
        }

        async function editMessage(id) {
            const msgRef = db.collection(`chats/${currentUser.chat}/messages`).doc(id);
            const doc = await msgRef.get();
            if (!doc.exists) return;

            const currentText = doc.data().text;
            const newText = prompt("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:", currentText);

            if (newText && newText !== currentText) {
                await msgRef.update({ text: newText, edited: true });
            }
        }
        
        // ... (handleImageUpload - –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π) ...
        function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const newW = img.width / 1.5;
                    const newH = img.height / 1.5;
                    
                    canvas.width = newW; 
                    canvas.height = newH;
                    
                    ctx.drawImage(img, 0, 0, newW, newH);
                    
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.6); 
                    
                    db.collection(`chats/${currentUser.chat}/messages`).add({
                        user: currentUser.name,
                        text: "üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
                        image: compressedDataUrl,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        edited: false,
                        status: 'sent' 
                    });
                    logStatus('WRITE', '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); 
                };
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê–ú–ò ---

        function updateActivity() {
            localStorage.setItem('lastActive', Date.now());
            if (Date.now() - lastStatusUpdateTime > 30000) {
                setUserStatus({ isOnline: true, isTyping: false });
            }
        }

        async function setUserStatus(statusUpdate) {
            if (!db || !currentUser.name) return;
            
            try {
                // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –ø–æ –ß–ê–¢ + –ò–ú–Ø
                await db.collection('users').doc(`${currentUser.chat}_${currentUser.name}`).set({ 
                    name: currentUser.name,
                    chat: currentUser.chat,
                    ...statusUpdate,
                    device: currentUser.device,
                    ip: currentUser.ip,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }); 
                logStatus('UPDATE_STATUS');
                lastStatusUpdateTime = Date.now();
            } catch (e) {
                console.error("Failed to update status", e);
            }
        }
        
        function checkInactivity() {
            const lastActive = localStorage.getItem('lastActive') || Date.now();
            if (Date.now() - lastActive > 180000) {
                alert("–°–µ–∞–Ω—Å –∑–∞–≤–µ—Ä—à–µ–Ω –∏–∑-–∑–∞ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è (3 –º–∏–Ω)");
                leaveRoom();
            }
        }

        // --- –ê–£–î–ò–¢ –õ–û–ì ---

        async function recordAudit(action, details = {}) {
            if (!db || !currentUser.name || !details.room) return;

            const logRef = db.collection('auditLogs');
            
            await logRef.add({
                chat: details.room,
                user: currentUser.name,
                ip: currentUser.ip,
                device: currentUser.device,
                action: action, 
                details: details,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        async function loadAuditLog() {
            const logContent = document.getElementById('log-content');
            const chatName = currentUser.chat;
            document.getElementById('log-chat-name').innerText = `# ${chatName}`;
            logContent.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...';

            try {
                const logs = await db.collection('auditLogs')
                    .where('chat', '==', chatName)
                    .orderBy('timestamp', 'desc')
                    .limit(100)
                    .get();

                logContent.innerHTML = ''; 
                
                logs.forEach(doc => {
                    const data = doc.data();
                    const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : '...';
                    let actionText = '';
                    let actionClass = 'action';
                    
                    switch (data.action) {
                        case 'login': actionText = '–í–û–®–ï–õ –≤ –∫–æ–º–Ω–∞—Ç—É.'; actionClass = 'auth'; break;
                        case 'logout': actionText = '–í–´–®–ï–õ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã.'; actionClass = 'auth'; break;
                        case 'send': actionText = `–û–¢–ü–†–ê–í–ò–õ —Å–æ–æ–±—â–µ–Ω–∏–µ: "${data.details.message.substring(0, 30)}..."`; break;
                        case 'read_msg': actionText = `–ü–†–û–ß–ò–¢–ê–õ —Å–æ–æ–±—â–µ–Ω–∏–µ ID: ${data.details.id.substring(0, 5)}...`; actionClass = 'read'; break;
                        case 'delete': actionText = `–£–î–ê–õ–ò–õ —Å–æ–æ–±—â–µ–Ω–∏–µ ID: ${data.details.id.substring(0, 5)}...`; break;
                        default: actionText = data.action;
                    }

                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'log-entry-item';
                    entryDiv.innerHTML = `
                        <span class="time">[${time}]</span>
                        <span class="user">${data.user}</span>
                        <span class="${actionClass}"> ${actionText}</span>
                        <span style="font-size: 9px; color: #aaa;">(${data.device})</span>
                    `;
                    logContent.appendChild(entryDiv);
                });

            } catch (e) {
                logContent.innerHTML = `<span style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤: ${e.message}</span>`;
                console.error("Error loading audit log:", e);
            }
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ü–£–°–ö–ï ---

        window.onload = () => {
            if (db) {
                checkAndLoadUser(); // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∏ –∑–∞–≥—Ä—É–∑–∫—É
            }
        };

        // --- –†–ï–ù–î–ï–†–ò–ù–ì –°–û–û–ë–©–ï–ù–ò–ô ---
        
        function renderMessages(messages) {
            const area = document.getElementById('messages-area');
            const atBottom = (area.scrollHeight - area.scrollTop - area.clientHeight) < 100;
            
            area.innerHTML = '';
            
            messages.forEach(msg => {
                const isMine = msg.user === currentUser.name;
                const div = document.createElement('div');
                div.className = `message ${isMine ? 'mine' : 'others'}`;
                
                const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';
                const editMark = msg.edited ? '<span style="font-size:9px;opacity:0.7"> (–∏–∑–º.)</span>' : '';
                const imgHtml = msg.image ? `<img src="${msg.image}" class="msg-img" onclick="window.open('${msg.image}')">` : '';
                const actions = isMine ? `<span class="msg-actions" onclick="editMessage('${msg.id}')">‚úèÔ∏è</span> <span class="msg-actions" onclick="deleteMessage('${msg.id}')">‚ùå</span>` : '';

                const nameColor = isMine ? '#00796b' : '#333333'; 

                let statusText = '';
                let statusClass = '';
                if (isMine) {
                    if (msg.status === 'delivered') {
                        statusText = '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ';
                        statusClass = 'delivered';
                    } else if (msg.status === 'sent') {
                        statusText = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
                        statusClass = 'sent';
                    }
                }
                const statusHtml = statusText ? `<span class="msg-status ${statusClass}">${statusText}</span>` : '';

                div.innerHTML = `
                    <span class="msg-sender" style="color:${nameColor}">${msg.user}</span>
                    <div style="margin-bottom:4px">${msg.text} ${editMark}</div>
                    ${imgHtml}
                    <div class="msg-meta">${time}${statusHtml} &nbsp; ${actions}</div>
                `;
                area.appendChild(div);
            });

            if(atBottom) scrollToBottom();
        }

        function renderOnlineUsers(users) {
            const now = Date.now();
            let onlineText = [];
            
            users.forEach(u => {
                const lastSeenTime = u.lastSeen ? u.lastSeen.toDate().getTime() : now;
                if (u.isOnline && now - lastSeenTime < 30000) {
                    onlineText.push(`${u.name} (${u.device})`); 
                }
            });
            document.getElementById('online-users').innerText = "–û–Ω–ª–∞–π–Ω: " + (onlineText.join(", ") || "–Ω–∏–∫–æ–≥–æ");
        }

        function renderTypingIndicator(users) {
            const now = Date.now();
            const typers = users
                .filter(u => u.name !== currentUser.name && u.isTyping && u.lastSeen && (now - u.lastSeen.toDate().getTime() < 5000))
                .map(u => u.name);
            
            document.getElementById('typing-indicator').innerText = typers.length ? typers.join(', ') + ' –ø–µ—á–∞—Ç–∞–µ—Ç...' : '';
        }

        function scrollToBottom() {
            const area = document.getElementById('messages-area');
            area.scrollTop = area.scrollHeight;
        }

        function logStatus(type, message) {
            const logElement = document.getElementById('status-log');
            const now = new Date().toLocaleTimeString();
            const entry = document.createElement('span');
            entry.className = 'log-entry';

            let tag = '';
            let cls = '';
            
            switch (type) {
                case 'WRITE': tag = 'Firestore: WRITE complete (Sent)'; cls = 'write'; break;
                case 'READ': tag = 'Firestore: READ/LISTEN complete (Received)'; cls = 'read'; break;
                case 'UPDATE_STATUS': tag = 'Firestore: WRITE User Status'; cls = 'write'; break;
                case 'INIT': tag = 'SDK: Initialized'; break;
                default: tag = message;
            }

            entry.innerHTML = `<span class="${cls}">[${now}] ${tag}</span>`;

            if (logElement.children.length >= MAX_LOG_ENTRIES) {
                logElement.removeChild(logElement.lastChild); 
            }
            logElement.prepend(entry);
        }

    </script>
</body>
</html>
